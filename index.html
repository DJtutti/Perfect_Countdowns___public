<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Perfect Countdowns   public</title>
  <style>
    :root {
      --bg-light: #ffffff;
      --bg-dark: #222;
      --text-dark: #000000;
      --text-light: #ffffff;
      --accent-gray: #888;
      --btn-border-color: #fff;
    }

    body {
      font-family: sans-serif;
      padding: 20px 20px 40px 20px;
      background: var(--bg-light);
      color: var(--text-dark);
      transition: background 0.3s, color 0.3s;
    }

    body.dark-mode {
      background: var(--bg-dark);
      color: var(--text-light);
    }

    #topBar {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 15px;
      flex-wrap: nowrap;
    }

    #countdownForm {
      display: flex;
      gap: 10px;
      align-items: center;
      margin: 0;
      flex-wrap: nowrap;
      margin-right: auto;
    }

    #countdownForm input,
    #countdownForm button {
      margin: 0;
      padding: 8px;
      font-size: 1em;
    }

    #color,
    #textColor {
      width: 50px;
      height: 40px;
      padding: 0;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    #controls {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    #controls button {
      padding: 5px 10px;
      font-size: 1em;
      cursor: pointer;
      background: none;
      border: 2px solid var(--btn-border-color);
      border-radius: 8px;
      color: inherit;
      transition: background 0.3s, color 0.3s;
    }

    #controls button:hover {
      background: var(--btn-border-color);
      color: var(--bg-dark);
    }

    #modeToggle {
      position: absolute;
      left: 66.7%;
      top: 6.7%;
      transform: translateY(-50%);
      padding: 5px 8px;
      border: 2px solid var(--btn-border-color);
      border-radius: 8px;
      background: none;
      cursor: pointer;
      color: inherit;
      transition: background 0.3s, color 0.3s;
    }

    #modeToggle:hover {
      background: var(--btn-border-color);
      color: var(--bg-dark);
    }

    .countdown-container {
      display: grid;
      gap: 20px;
      margin-top: 20px;
    }

    .countdown {
      padding: 20px;
      border-radius: 10px;
      position: relative;
      box-shadow: 0 0 8px #aaa;
      color: #fff;
    }

    .countdown .title {
      font-size: 1.4em;
      font-weight: bold;
      text-align: center;
      margin-bottom: 8px;
    }

    .countdown .time {
      font-size: 1.6em;
      font-weight: 600;
      text-align: center;
      background: rgba(255, 255, 255, 0.2);
      padding: 5px 10px;
      border-radius: 6px;
      text-shadow: 0 1px 2px #00000066;
    }

    .countdown .time span.num {
      font-weight: 700;
      font-size: 1.7em;
    }

    .countdown .time span.unit {
      opacity: 0.6;
      font-size: 0.9em;
      margin-right: 6px;
    }

    .countdown button {
      position: absolute;
      top: 10px;
      background: rgba(255, 255, 255, 0.7);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      padding: 4px 8px;
    }

    .remove-btn {
      right: 10px;
    }

    .edit-btn {
      right: 60px;
    }

    .hidden {
      display: none !important;
    }

    .cols-1 { grid-template-columns: 1fr; }
    .cols-2 { grid-template-columns: repeat(2, 1fr); }
    .cols-3 { grid-template-columns: repeat(3, 1fr); }
    .cols-4 { grid-template-columns: repeat(4, 1fr); }
    .cols-5 { grid-template-columns: repeat(5, 1fr); }
  </style>
</head>
<body>
  <div id="topBar">
    <form id="countdownForm" class="hidden">
      <input type="text" id="title" placeholder="Nome do evento" required />
      <input type="datetime-local" id="date" required />
      <input type="color" id="color" value="#007BFF" />
      <input type="color" id="textColor" value="#ffffff" />
      <button type="submit">Adicionar</button>
    </form>

    <div id="controls" class="hidden">
      <button onclick="setColumns(1)">â˜°</button>
      <button onclick="setColumns(2)">2</button>
      <button onclick="setColumns(3)">3</button>
      <button onclick="setColumns(4)">4</button>
      <button onclick="setColumns(5)">â˜·</button>
    </div>

    <button id="creatorUnlock" onclick="requestPIN()">ðŸ”’ Criador (DJ_tutti)</button>
    <button id="modeToggle" onclick="toggleMode()">â˜€</button>
  </div>

  <div id="countdownContainer" class="countdown-container cols-3"></div>

  <script>
    const PIN = "0955";
    let canEdit = false;

    const form = document.getElementById('countdownForm');
    const container = document.getElementById('countdownContainer');
    const modeToggle = document.getElementById('modeToggle');
    const creatorBtn = document.getElementById('creatorUnlock');
    const controls = document.getElementById('controls');

    const STORAGE_KEY = "countdowns_public";
    let countdowns = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    let columnCount = 3;
    let savedColumns = localStorage.getItem("countdown_columns_public");
    if (savedColumns) {
      columnCount = parseInt(savedColumns);
      container.className = `countdown-container cols-${columnCount}`;
    }

    function saveCountdowns() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(countdowns));
    }

    function setColumns(n) {
      columnCount = n;
      container.className = `countdown-container cols-${n}`;
      localStorage.setItem("countdown_columns_public", n); // ðŸ‘ˆ salva a escolha
    }

    function requestPIN() {
      const entered = prompt("Introduz o PIN para editar:");
      if (entered === PIN) {
        canEdit = true;
        alert("Acesso concedido.");
        creatorBtn.classList.add("hidden");
        form.classList.remove("hidden");
        controls.classList.remove("hidden");
        updateCountdowns();
      } else {
        alert("PIN incorreto.");
      }
    }

    function removeCountdown(index) {
      countdowns.splice(index, 1);
      saveCountdowns();
      updateCountdowns();
    }

    function editCountdown(index) {
      const cd = countdowns[index];
      const newTitle = prompt("Novo nome:", cd.title) || cd.title;
      const newDate = prompt("Nova data (YYYY-MM-DD HH:MM):", cd.date.replace("T", " ")) || cd.date;
      const newColor = prompt("Nova cor (#hex):", cd.color) || cd.color;
      const newTextColor = prompt("Nova cor do texto (#hex):", cd.textColor || '#ffffff') || cd.textColor;

      countdowns[index] = { title: newTitle, date: newDate, color: newColor, textColor: newTextColor };
      saveCountdowns();
      updateCountdowns();
    }

    function formatTime(diff) {
      if (diff <= 0) return 'Finalizado!';

      const msPerMonth = 1000 * 60 * 60 * 24 * 30.44;
      const msPerDay = 1000 * 60 * 60 * 24;

      const months = Math.floor(diff / msPerMonth);
      const days = Math.floor((diff % msPerMonth) / msPerDay);
      const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
      const minutes = Math.floor((diff / (1000 * 60)) % 60);
      const seconds = Math.floor((diff / 1000) % 60);
      
      return `
        ${months > 0 ? `<span class="num">${months}</span><span class="unit">M</span>` : ''}
        ${days > 0 ? `<span class="num">${days}</span><span class="unit">d</span>` : ''}
        <span class="num">${hours}</span><span class="unit">h</span>
        <span class="num">${minutes}</span><span class="unit">m</span>
        <span class="num">${seconds}</span><span class="unit">s</span>
      `;
    }

    function updateCountdowns() {
      container.innerHTML = '';
      const now = new Date();

      countdowns.forEach((cd, i) => {
        const finalTime = new Date(cd.date);
        const diff = finalTime - now;

        const div = document.createElement('div');
        div.className = 'countdown';
        div.style.background = cd.color || '#007BFF';
        div.style.color = cd.textColor || '#ffffff';

        div.innerHTML = `
          <div class="title">${cd.title}</div>
          <div class="time">${formatTime(diff)}</div>
        `;

        if (canEdit) {
          const editBtn = document.createElement("button");
          editBtn.className = "edit-btn";
          editBtn.textContent = "âœï¸";
          editBtn.onclick = () => editCountdown(i);
          div.appendChild(editBtn);

          const removeBtn = document.createElement("button");
          removeBtn.className = "remove-btn";
          removeBtn.textContent = "âŒ";
          removeBtn.onclick = () => removeCountdown(i);
          div.appendChild(removeBtn);
        }

        container.appendChild(div);
      });
    }

    form.addEventListener('submit', e => {
      e.preventDefault();
      if (!canEdit) {
        alert("Apenas o criador pode adicionar eventos.");
        return;
      }

      const title = document.getElementById('title').value;
      const date = document.getElementById('date').value;
      const color = document.getElementById('color').value;
      const textColor = document.getElementById('textColor').value;
      countdowns.push({ title, date, color, textColor });
      saveCountdowns();
      updateCountdowns();
      form.reset();
    });

    function toggleMode() {
      document.body.classList.toggle('dark-mode');
      modeToggle.textContent = document.body.classList.contains('dark-mode') ? 'â˜¾' : 'â˜€';
    }

    setInterval(updateCountdowns, 1000);
    updateCountdowns();
  </script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  
    const firebaseConfig = {
      apiKey: "AIzaSyC5PRsrlWsXxWvAN0butuC8jL81xveS9UI",
      authDomain: "perfect-countdowns---public.firebaseapp.com",
      projectId: "perfect-countdowns---public",
      storageBucket: "perfect-countdowns---public.firebasestorage.app",
      messagingSenderId: "61334374176",
      appId: "1:61334374176:web:ba7639dd7ad676c300b945",
      measurementId: "G-FSNPFQD8BH"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const countdownsRef = collection(db, "countdowns");

    // Atualiza a interface sempre que houver alteraÃ§Ãµes na base de dados
    onSnapshot(countdownsRef, (snapshot) => {
      const container = document.getElementById("countdownContainer");
      container.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.className = "countdown";
        div.innerHTML = `
          <div class="title">${data.title}</div>
          <div class="date">${data.date} ${data.time}</div>
        `;
        container.appendChild(div);
      });
    });
  </script>
</body>
</html>
